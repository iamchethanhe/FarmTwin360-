import React, { useState, useEffect } from 'react';
import { NavigationContainer } from '@react-navigation/native';
import { createStackNavigator } from '@react-navigation/stack';
import { createBottomTabNavigator } from '@react-navigation/bottom-tabs';
import { createMaterialTopTabNavigator } from '@react-navigation/material-top-tabs';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { ActivityIndicator, View, Text } from 'react-native';
// Screens\nimport LoginScreen from './screens/LoginScreen';\nimport DashboardScreen from './screens/DashboardScreen';\nimport ChecklistScreen from './screens/ChecklistScreen';\nimport IncidentScreen from './screens/IncidentScreen';\nimport ProfileScreen from './screens/ProfileScreen';\n\n// Admin Screens\nimport AdminUserManagementScreen from './screens/AdminUserManagementScreen';\nimport AdminFarmManagementScreen from './screens/AdminFarmManagementScreen';\nimport AdminFarmAssignmentsScreen from './screens/AdminFarmAssignmentsScreen';\nimport AdminBarnManagementScreen from './screens/AdminBarnManagementScreen';\nimport AdminSystemStatsScreen from './screens/AdminSystemStatsScreen';\n\n// Manager Screens\nimport ManagerApprovalsScreen from './screens/ManagerApprovalsScreen';\n\n// Analytics Screen\nimport AnalyticsScreen from './screens/AnalyticsScreen';\n\nconst Stack = createStackNavigator();\nconst Tab = createBottomTabNavigator();\nconst TopTab = createMaterialTopTabNavigator();\n\n// Admin Management Stack\nfunction AdminManagementStack() {\n  return (\n    <Stack.Navigator\n      screenOptions={{\n        headerStyle: { backgroundColor: '#F44336' },\n        headerTintColor: '#fff',\n        headerTitleStyle: { fontWeight: 'bold' },\n      }}\n    >\n      <Stack.Screen\n        name=\"AdminUserManagement\"\n        component={AdminUserManagementScreen}\n        options={{ title: 'User Management' }}\n      />\n      <Stack.Screen\n        name=\"AdminFarmManagement\"\n        component={AdminFarmManagementScreen}\n        options={{ title: 'Farm Management' }}\n      />\n      <Stack.Screen\n        name=\"AdminFarmAssignments\"\n        component={AdminFarmAssignmentsScreen}\n        options={{ title: 'Farm Assignments' }}\n      />\n      <Stack.Screen\n        name=\"AdminBarnManagement\"\n        component={AdminBarnManagementScreen}\n        options={{ title: 'Barn Management' }}\n      />\n      <Stack.Screen\n        name=\"AdminSystemStats\"\n        component={AdminSystemStatsScreen}\n        options={{ title: 'System Statistics' }}\n      />\n    </Stack.Navigator>\n  );\n}\n\n// Manager Approvals Stack\nfunction ManagerApprovalsStack() {\n  return (\n    <Stack.Navigator\n      screenOptions={{\n        headerStyle: { backgroundColor: '#2196F3' },\n        headerTintColor: '#fff',\n        headerTitleStyle: { fontWeight: 'bold' },\n      }}\n    >\n      <Stack.Screen\n        name=\"ManagerApprovals\"\n        component={ManagerApprovalsScreen}\n        options={{ title: 'Approvals' }}\n      />\n    </Stack.Navigator>\n  );\n}\n\n// Main Tab Navigator\nfunction MainTabs({ userRole, onLogout }) {\n  return (\n    <Tab.Navigator\n      screenOptions={{\n        tabBarActiveTintColor: '#4CAF50',\n        tabBarInactiveTintColor: '#81C784',\n        tabBarStyle: {\n          backgroundColor: '#fff',\n          borderTopWidth: 0,\n          elevation: 10,\n          shadowColor: '#000',\n          shadowOffset: { width: 0, height: -2 },\n          shadowOpacity: 0.1,\n          shadowRadius: 4,\n        },\n        headerStyle: {\n          backgroundColor: '#4CAF50',\n        },\n        headerTintColor: '#fff',\n        headerTitleStyle: {\n          fontWeight: 'bold',\n        },\n      }}\n    >\n      <Tab.Screen\n        name=\"Dashboard\"\n        component={DashboardScreen}\n        options={{\n          tabBarIcon: ({ color }) => <Text style={{ fontSize: 24 }}>üè†</Text>,\n          headerShown: false,\n        }}\n      />\n\n      {/* Worker-only screens */}\n      {userRole === 'worker' && (\n        <>\n          <Tab.Screen\n            name=\"Checklist\"\n            component={ChecklistScreen}\n            options={{\n              tabBarIcon: ({ color }) => <Text style={{ fontSize: 24 }}>‚úì</Text>,\n              title: 'New Checklist',\n            }}\n          />\n          <Tab.Screen\n            name=\"Incident\"\n            component={IncidentScreen}\n            options={{\n              tabBarIcon: ({ color }) => <Text style={{ fontSize: 24 }}>‚ö†</Text>,\n              title: 'Report Incident',\n            }}\n          />\n        </>\n      )}\n\n      {/* Admin-only screens */}\n      {userRole === 'admin' && (\n        <Tab.Screen\n          name=\"AdminManagement\"\n          component={AdminManagementStack}\n          options={{\n            tabBarIcon: ({ color }) => <Text style={{ fontSize: 24 }}>üëë</Text>,\n            title: 'Admin',\n            headerShown: false,\n          }}\n        />\n      )}\n\n      {/* Manager-only screens */}\n      {userRole === 'manager' && (\n        <Tab.Screen\n          name=\"ManagerStack\"\n          component={ManagerApprovalsStack}\n          options={{\n            tabBarIcon: ({ color }) => <Text style={{ fontSize: 24 }}>‚úÖ</Text>,\n            title: 'Approvals',\n            headerShown: false,\n          }}\n        />\n      )}\n\n      {/* Analytics for admin/manager/vet/auditor */}\n      {['admin', 'manager', 'vet', 'auditor'].includes(userRole) && (\n        <Tab.Screen\n          name=\"Analytics\"\n          component={AnalyticsScreen}\n          options={{\n            tabBarIcon: ({ color }) => <Text style={{ fontSize: 24 }}>üìä</Text>,\n            title: 'Analytics',\n          }}\n        />\n      )}\n\n      <Tab.Screen\n        name=\"Profile\"\n        options={{\n          tabBarIcon: ({ color }) => <Text style={{ fontSize: 24 }}>üë§</Text>,\n        }}\n      >\n        {(props) => <ProfileScreen {...props} onLogout={onLogout} />}\n      </Tab.Screen>\n    </Tab.Navigator>\n  );\n}\n\nexport default function App() {\n  const [isLoggedIn, setIsLoggedIn] = useState(false);\n  const [isLoading, setIsLoading] = useState(true);\n  const [userRole, setUserRole] = useState(null);\n\n  useEffect(() => {\n    checkAuthStatus();\n  }, []);\n\n  const checkAuthStatus = async () => {\n    try {\n      const token = await AsyncStorage.getItem('authToken');\n      const user = await AsyncStorage.getItem('user');\n      if (token && user) {\n        const userData = JSON.parse(user);\n        setUserRole(userData.role);\n        setIsLoggedIn(true);\n      }\n    } catch (error) {\n      console.error('Error checking auth status:', error);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const refreshAuthState = async () => {\n    const token = await AsyncStorage.getItem('authToken');\n    const user = await AsyncStorage.getItem('user');\n    if (token && user) {\n      const userData = JSON.parse(user);\n      setUserRole(userData.role);\n      setIsLoggedIn(true);\n    }\n  };\n\n  const handleLogout = async () => {\n    setIsLoggedIn(false);\n    setUserRole(null);\n  };\n\n  if (isLoading) {\n    return (\n      <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>\n        <ActivityIndicator size=\"large\" color=\"#4CAF50\" />\n      </View>\n    );\n  }\n\n  return (\n    <NavigationContainer>\n      <Stack.Navigator screenOptions={{ headerShown: false }}>\n        {!isLoggedIn ? (\n          <Stack.Screen name=\"Login\">\n            {(props) => <LoginScreen {...props} onLoginSuccess={refreshAuthState} />}\n          </Stack.Screen>\n        ) : (\n          <Stack.Screen name=\"Main\">\n            {(props) => (\n              <MainTabs {...props} userRole={userRole} onLogout={handleLogout} />\n            )}\n          </Stack.Screen>\n        )}\n      </Stack.Navigator>\n    </NavigationContainer>\n  );\n}\n